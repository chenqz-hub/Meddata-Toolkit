# 批量合并功能使用指南

## 📦 功能简介

批量合并功能允许您一次性配置多个文件对的合并任务，然后批量执行，大大提高工作效率。

## 🚀 使用步骤

### 1. 打开批量合并模式

- 启动**专业版合并工具**
- 点击菜单栏：`文件` → `批量合并模式`
- 或使用启动工具选择选项 4

### 2. 添加合并任务

点击 `➕ 添加任务` 按钮，在弹出窗口中配置：

#### 文件1设置
- **文件**: 点击"浏览"选择第一个Excel文件
- **Sheet**: 从下拉框选择要合并的工作表

#### 文件2设置
- **文件**: 点击"浏览"选择第二个Excel文件
- **Sheet**: 从下拉框选择要合并的工作表

#### 合并设置
- **匹配字段**: 点击"分析"按钮自动识别共同字段，或手动选择
- **合并类型**: 选择 LEFT、RIGHT、INNER 或 OUTER JOIN

#### 输出设置
- **输出文件**: 指定合并结果保存的位置和文件名

### 3. 管理任务列表

- **查看任务**: 任务列表显示所有配置的合并任务
- **删除任务**: 选中任务后点击 `🗑️ 删除选中`
- **清空列表**: 点击 `🗑️ 清空所有` 删除所有任务

### 4. 执行批量合并

- 点击 `▶️ 开始批量合并` 按钮
- 进度条显示当前执行进度
- 执行日志实时显示每个任务的处理情况
- 完成后弹窗提示成功/失败数量

## 📊 任务列表说明

| 列名 | 说明 |
|------|------|
| 序号 | 任务编号 |
| 文件1 | 第一个Excel文件名 |
| Sheet1 | 第一个文件的工作表 |
| 文件2 | 第二个Excel文件名 |
| Sheet2 | 第二个文件的工作表 |
| 匹配字段 | 用于合并的关键字段 |
| 合并类型 | LEFT/RIGHT/INNER/OUTER |
| 输出文件 | 结果文件名 |
| 状态 | 待执行/执行中/✓完成/✗失败 |

## 📝 执行日志

日志区域实时显示：
- 当前处理的任务编号
- 输入文件信息
- 合并配置
- 结果维度
- 输出文件位置
- 执行状态（成功/失败）

## 💡 使用技巧

### 1. 批量处理同类文件
如果有多组结构相同的文件需要合并，可以：
- 添加第一个任务并完整配置
- 后续任务只需修改文件路径和输出路径
- 保持相同的Sheet名称、匹配字段和合并类型

### 2. 使用模板
对于经常重复的合并操作：
1. 在单文件合并模式中配置好设置
2. 保存为模板
3. 在批量模式中使用相同配置

### 3. 组织输出文件
建议为批量合并结果创建专门的输出文件夹：
```
D:\合并结果\
├── 批次1_PCI_MATA_20251028.xlsx
├── 批次2_CAG_MATA_20251028.xlsx
└── 批次3_Normal_MATA_20251028.xlsx
```

### 4. 检查执行日志
合并完成后务必查看日志：
- ✓ 符号表示成功
- ✗ 符号表示失败（查看错误信息）
- 检查结果维度是否符合预期

## ⚠️ 注意事项

1. **内存占用**: 批量合并会同时处理多个文件，确保有足够的内存
2. **文件路径**: 输出文件路径会自动创建不存在的文件夹
3. **数据验证**: 批量执行前建议先用单个任务测试配置是否正确
4. **字段匹配**: 确保匹配字段在两个文件中都存在且格式一致
5. **备份数据**: 执行批量操作前建议备份原始数据

## 🔍 常见问题

### Q1: 任务执行失败怎么办？
**A**: 查看执行日志中的错误信息，常见原因：
- 文件路径不存在
- 匹配字段不存在
- Sheet名称错误
- 文件正在被其他程序占用

### Q2: 可以中途取消吗？
**A**: 批量执行开始后会按顺序处理所有任务，建议：
- 关闭窗口可以终止（已完成的任务结果会保留）
- 或等待全部完成后处理失败的任务

### Q3: 如何保存批量任务配置？
**A**: 当前版本任务列表关闭后不会保存，建议：
- 创建Excel表格记录常用配置
- 或使用模板功能保存单个任务配置

### Q4: 批量合并很慢怎么办？
**A**: 影响速度的因素：
- 文件大小（大文件需要更多时间）
- 任务数量
- 磁盘读写速度
- 建议处理大批量任务时分批执行

## 📈 实际应用场景

### 场景1: 多批次患者数据合并
```
任务1: PCI组_批次1.xlsx + MATA_CHD_批次1.xlsx → 结果1.xlsx
任务2: PCI组_批次2.xlsx + MATA_CHD_批次2.xlsx → 结果2.xlsx
任务3: PCI组_批次3.xlsx + MATA_CHD_批次3.xlsx → 结果3.xlsx
```

### 场景2: 不同分组数据整合
```
任务1: CAG组.xlsx + MATA_Normal组.xlsx → CAG_Normal_完整.xlsx
任务2: PCI组.xlsx + MATA_CHD组.xlsx → PCI_CHD_完整.xlsx
任务3: Control组.xlsx + MATA_Control组.xlsx → Control_完整.xlsx
```

### 场景3: 多中心数据汇总
```
任务1: 中心A_基线.xlsx + 中心A_随访.xlsx → 中心A_完整.xlsx
任务2: 中心B_基线.xlsx + 中心B_随访.xlsx → 中心B_完整.xlsx
任务3: 中心C_基线.xlsx + 中心C_随访.xlsx → 中心C_完整.xlsx
```

## 🎯 最佳实践

1. **先测试后批量**: 用一个任务验证配置正确后再批量执行
2. **规范命名**: 使用有意义的文件名，便于识别和管理
3. **记录日志**: 保存执行日志文本，便于后续追溯
4. **定期备份**: 批量操作前备份重要数据
5. **分批处理**: 大量任务建议分批执行，避免系统负载过高

## 📞 技术支持

如遇到问题，请查看：
- 执行日志中的详细错误信息
- `工具使用指南.md` 基础功能说明
- `README.md` 项目总体介绍

---

**版本**: 2.0.0  
**更新日期**: 2025-10-28  
**Meddata Toolkit Team**
