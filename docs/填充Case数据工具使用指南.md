# 填充 Case 数据工具 - 使用指南

## 📝 工具说明

**功能**：从原始表中填充合并表现有 case 的缺失字段值

**适用场景**：
- 合并表中已有 case 记录（行存在）
- 但部分字段值为空
- 这些空值字段的数据在原始表中有

## 🚀 快速开始

### 方式1：主菜单启动（推荐）
```bash
python 启动工具.py
# 选择选项 7
```

### 方式2：批处理文件
```bash
run_fill_data.bat
```

### 方式3：命令行
```bash
python tools/fill_case_data.py --merged 合并表.xlsx --source 原始表.xlsx --key patient_id
```

## 💡 使用示例

### 场景说明
有一个合并表 `merged.xlsx`，部分字段为空：

| patient_id | name | age | blood_pressure | cholesterol |
|------------|------|-----|----------------|-------------|
| P001       | 张三  | 45  | **(空)**       | 220         |
| P002       | 李四  | 52  | **(空)**       | **(空)**    |
| P003       | 王五  | **(空)** | 125/80    | 210         |

原始表 `original.xlsx` 有完整数据：

| patient_id | name | age | blood_pressure | cholesterol |
|------------|------|-----|----------------|-------------|
| P001       | 张三  | 45  | **130/85**     | 220         |
| P002       | 李四  | 52  | **140/90**     | **245**     |
| P003       | 王五  | **48** | 125/80      | 210         |

### 执行填充
```bash
python tools/fill_case_data.py --merged merged.xlsx --source original.xlsx --key patient_id
```

### 填充结果 `merged_已填充.xlsx`

| patient_id | name | age | blood_pressure | cholesterol |
|------------|------|-----|----------------|-------------|
| P001       | 张三  | 45  | **130/85** ✅   | 220         |
| P002       | 李四  | 52  | **140/90** ✅   | **245** ✅  |
| P003       | 王五  | **48** ✅ | 125/80      | 210         |

### 统计报告
```
✓ 填充完成！
总 case 数: 3
匹配到的 case 数: 3
总共填充单元格数: 4

各字段填充情况:
  blood_pressure: 2 个值
  cholesterol: 1 个值
  age: 1 个值
```

## 🎯 核心逻辑

```
对于合并表中的每个 case:
    ├─ 根据 patient_id 在原始表中查找匹配行
    ├─ 对于每个共同字段:
    │   ├─ 检查：合并表中是否为空？
    │   ├─ 检查：原始表中是否有值？
    │   └─ 如果都满足 → 填充
    └─ 已有值 → 不覆盖
```

## ⚙️ 参数说明

| 参数 | 简写 | 说明 | 示例 |
|------|------|------|------|
| `--merged` | `-m` | 合并表文件（需要填充的表） | `merged.xlsx` |
| `--source` | `-s` | 原始表文件（数据来源） | `original.xlsx` |
| `--key` | `-k` | 用于匹配的键字段名 | `patient_id` |
| `--output` | `-o` | 输出文件路径（可选） | `result.xlsx` |

## ✅ 功能特点

- ✅ **只填充空值**：不覆盖已有数据
- ✅ **精确匹配**：基于键字段（如 `patient_id`）匹配
- ✅ **智能字段对齐**：只处理共同字段
- ✅ **详细统计**：显示每个字段的填充数量
- ✅ **保留原文件**：生成新文件，原文件不变
- ✅ **支持多格式**：Excel (.xlsx, .xls) 和 CSV

## ⚠️ 注意事项

1. **键字段必须存在**：两个表都必须有相同的键字段（如 `patient_id`）
2. **只处理共同字段**：原始表独有的字段会被忽略
3. **空值判断**：`NaN`、空字符串、None 都被视为空值
4. **不覆盖原有数据**：已有值不会被替换
5. **生成新文件**：输出文件为 `原文件名_已填充.xlsx`

## 🔍 常见问题

### Q1: 如何知道哪些字段可以填充？
工具会自动分析并显示：
```
找到 5 个共同字段（可用于填充）:
  1. name (合并表中有 0 个空值)
  2. age (合并表中有 1 个空值)
  3. diagnosis (合并表中有 1 个空值)
  4. blood_pressure (合并表中有 3 个空值)
  5. cholesterol (合并表中有 2 个空值)
```

### Q2: 如果键字段值不匹配会怎样？
不匹配的 case 会被跳过，不会填充。统计报告会显示实际匹配到的 case 数量。

### Q3: 原始表有多行相同的 patient_id 怎么办？
工具会使用第一行匹配的数据进行填充。

### Q4: 填充后发现错误，可以撤销吗？
原文件未被修改，直接使用原文件即可。如需重新填充，删除 `_已填充` 文件后重新运行。

## 📊 与其他工具的区别

| 工具 | 用途 | 场景 |
|------|------|------|
| **填充 Case 数据** | 填充现有 case 的空白字段 | 行存在，字段值缺失 |
| 补充缺失 Case | 添加整个缺失的 case 行 | 整行缺失 |
| 跨文件合并 | 合并两个表 | 初次合并数据 |
| 去重工具 | 删除重复记录 | 存在重复数据 |

## 🎓 学习资源

- **完整示例代码**：`examples/fill_case_data_example.py`
- **测试数据**：`examples/test_merged.xlsx`, `examples/test_original.xlsx`
- **主文档**：`README.md`

## 💻 技术支持

如有问题，请查看：
1. 运行 `python tools/fill_case_data.py --help` 查看帮助
2. 查看示例代码 `examples/fill_case_data_example.py`
3. 提交 GitHub Issue

---

**提示**：首次使用建议先用测试数据练习，确保理解工具行为后再处理实际数据。
