# 早发冠心病数据处理工具集

## 📁 项目结构

```
Early CHD Project/
├── tools/                          # 核心数据处理工具
│   ├── merge_tool_gui.py          # 单文件多sheet合并工具
│   ├── cross_merge_gui.py         # 跨文件合并工具
│   ├── deduplicate_tool.py        # 重复记录去重工具
│   ├── check_join_fields.py       # 字段唯一性检查工具
│   ├── Medical_Manuscript_Formatter/ # 论文格式化工具
│   └── Medical_Reference_Verifier/   # 参考文献验证工具
│
├── docs/                           # 数据文件目录
├── src/                            # 源代码包
├── tests/                          # 测试文件
├── archive/                        # 旧版本工具（已弃用）
├── examples/                       # 示例文件
│
├── requirements.txt                # Python依赖包
├── README.md                       # 项目说明（中文）
└── 工具使用指南.md                 # 本文件
```

## 🛠️ 核心工具说明

### 1. 单文件多Sheet合并工具 (`merge_tool_gui.py`)

**功能：** 将同一个Excel文件中的多个sheet合并成一个完整表格

**适用场景：**
- 一个患者的数据分散在多个sheet中（如：基本信息、检查结果、随访记录等）
- 需要将所有sheet按患者ID横向合并

**特点：**
- ✅ GUI文件选择对话框
- ✅ 自动识别共同字段和唯一字段
- ✅ 智能选择主表和连接字段
- ✅ 零重复字段保证
- ✅ 支持自定义输出位置

**使用方法：**
```bash
python tools/merge_tool_gui.py
```

**操作步骤：**
1. 弹窗选择要处理的Excel文件
2. 工具自动分析所有sheet
3. 自动合并（基于共同ID字段）
4. 弹窗选择保存位置
5. 完成！可选自动打开结果文件

**输出：**
- 主表：合并后的完整数据
- 信息表：合并详情（文件名、sheet数、字段数等）

---

### 2. 跨文件合并工具 (`cross_merge_gui.py`)

**功能：** 将两个不同Excel文件的数据按ID字段合并

**适用场景：**
- 两个文件包含同一批患者的不同数据
- 需要按患者ID关联合并

**特点：**
- ✅ GUI文件选择对话框
- ✅ 支持字段名不同的ID匹配（如 subjid vs patient_id）
- ✅ 精确+模糊字段匹配（相似度>80%）
- ✅ **唯一性检查**：自动检测ID重复并警告
- ✅ 支持4种连接方式：left/right/inner/outer join
- ✅ 详细的合并信息追踪

**使用方法：**
```bash
python tools/cross_merge_gui.py
```

**操作步骤：**
1. 弹窗选择第一个Excel文件
2. 弹窗选择第二个Excel文件
3. 查看共同字段列表
4. 选择连接字段：
   - 如果字段名相同：选择编号（1-N）
   - 如果字段名不同：选择 0，然后手动输入两个字段名
5. **重要：** 工具会检查字段唯一性
   - ✅ 唯一 → 安全合并
   - ⚠️ 有重复 → 显示警告，询问是否继续
6. 选择合并类型（1-4）
7. 弹窗选择保存位置
8. 完成！

**合并类型说明：**
- **1. Left join** - 保留文件1的所有记录（推荐）
- **2. Right join** - 保留文件2的所有记录
- **3. Inner join** - 只保留两个文件都有的记录
- **4. Outer join** - 保留两个文件的所有记录

**⚠️ 重要提示：**

**不要使用会重复的字段作为连接键！**

❌ **错误示例：**
- `stname`（姓名）- 会有重名
- `sys_currentage`（年龄）- 多人同龄
- `stsex`（性别）- 只有男/女两个值
- `groupdate`（日期）- 多人同一天

✅ **正确示例：**
- `subjid` - 受试者唯一ID
- `patientingroupid` - 患者分组ID
- `sys_idcard` - 身份证号
- `case_number` - 病例编号

**输出：**
- 主表：Merged Data
- 信息表：Merge Info（包含合并字段、类型、数据量等）

---

### 3. 重复记录去重工具 (`deduplicate_tool.py`)

**功能：** 当合并后发现重复记录，可以去重保留最新/最早记录

**适用场景：**
- 合并后发现同一患者有多条记录
- 需要每个患者只保留一条记录

**特点：**
- ✅ GUI文件选择
- ✅ 自动识别ID列
- ✅ 自动识别日期列
- ✅ 4种去重策略

**使用方法：**
```bash
python tools/deduplicate_tool.py
```

**去重策略：**
1. **保留第一条记录** - 按原始行顺序
2. **保留最后一条记录** - 按原始行顺序（默认）
3. **按日期保留最早记录** - 需选择日期列
4. **按日期保留最新记录** - 需选择日期列

**输出：**
- 主表：Deduplicated Data
- 信息表：Dedup Info（去重方法、删除记录数等）

---

### 4. 字段唯一性检查工具 (`check_join_fields.py`)

**功能：** 在合并前检查两个文件的共同字段是否唯一

**适用场景：**
- 不确定用哪个字段合并
- 想知道哪些字段是唯一标识符

**使用方法：**
```bash
python tools/check_join_fields.py
```

**输出示例：**
```
Field                    File1 Total  File1 Unique  File2 Total  File2 Unique  Suitable?
------------------------------------------------------------------------------------------------
subjid                   263          263           340          340           ✓ YES
patientingroupid         263          263           340          340           ✓ YES
stname                   263          250           340          320           
sys_currentage           263          45            340          52            
```

---

### 5. 论文格式化工具 (`Medical_Manuscript_Formatter`)

**功能：** 将Markdown论文草稿转换为符合学术投稿要求的Word文档

**适用场景：**
- 准备投稿论文
- 需要严格的格式控制（行号、页边距、双倍行距）
- 自动转换Markdown表格为三线表

**使用方法：**
```bash
python tools/Medical_Manuscript_Formatter/format_manuscript.py
```

---

### 6. 参考文献验证工具 (`Medical_Reference_Verifier`)

**功能：** 验证参考文献的真实性并生成RIS引用文件

**适用场景：**
- 检查引用的论文是否存在
- 自动获取DOI和PubMed ID
- 生成EndNote/Zotero可导入的RIS文件

**使用方法：**
```bash
python tools/Medical_Reference_Verifier/verify_medical_references.py
```

---

## 🚀 快速开始

### 环境配置

1. **激活虚拟环境**（如果有）：
```bash
.venv\Scripts\activate
```

2. **安装依赖**（如果还没安装）：
```bash
pip install -r requirements.txt
```

### 常见工作流程

#### 场景1：合并同一文件的多个sheet
```bash
python tools/merge_tool_gui.py
# 选择文件 → 自动合并 → 保存
```

#### 场景2：合并两个文件的数据
```bash
# 步骤1：检查字段唯一性（可选）
python tools/check_join_fields.py

# 步骤2：执行跨文件合并
python tools/cross_merge_gui.py
# 注意：选择唯一的ID字段！

# 步骤3：如果有重复记录，去重（可选）
python tools/deduplicate_tool.py
```

---

## ⚠️ 常见问题与解决

### Q1: 合并后为什么有很多重复记录？

**原因：** 使用了非唯一字段作为连接键（如姓名、年龄）

**解决：**
1. 重新运行 `cross_merge_gui.py`
2. 选择唯一的ID字段（如 subjid、patient_id）
3. 参考工具的唯一性检查警告

### Q2: 两个文件的ID字段名不同怎么办？

**解决：**
在 `cross_merge_gui.py` 中：
- 选择 `0. Use DIFFERENT field names`
- 手动输入两个字段名
- 工具会自动处理

### Q3: 如何知道哪个字段是唯一的？

**解决：**
运行 `check_join_fields.py`，它会显示每个字段的唯一性

### Q4: 合并时应该选哪种join类型？

**建议：**
- **Left join**（选项1）- 最常用，保留第一个文件的所有患者
- **Inner join**（选项3）- 只保留两个文件都有的患者（数据最完整）
- **Outer join**（选项4）- 保留所有患者（可能有很多缺失值）

---

## 📊 数据质量检查清单

合并前请确认：
- ✅ ID字段在两个文件中都是唯一的（无重复）
- ✅ ID字段的数据类型一致（都是数字或都是文本）
- ✅ 没有空值或异常值
- ✅ 字段名正确（注意大小写）

合并后请检查：
- ✅ 记录数是否符合预期
- ✅ 是否有意外的重复记录
- ✅ 关键字段的缺失值比例
- ✅ 字段名有无 `_file1` / `_file2` 后缀（表示有重叠字段）

---

## 📝 输出文件命名规则

工具会自动生成带时间戳的文件名：

- 单文件合并：`原文件名_merged_20251025_174457.xlsx`
- 跨文件合并：`cross_merge_20251025_191710.xlsx`
- 去重文件：`原文件名_dedup_20251025_193020.xlsx`

---

## 💡 最佳实践

1. **先小范围测试**：用少量数据测试工具是否正常工作
2. **保留原始文件**：工具不会修改原文件，但建议备份
3. **检查唯一性**：合并前务必确认ID字段唯一
4. **查看信息表**：每次合并后检查"Merge Info"或"Dedup Info"sheet
5. **记录操作**：记下使用的字段和参数，便于重复操作

---

## 🔧 技术支持

如有问题，请检查：
1. Python版本（建议3.8+）
2. 依赖包是否完整安装：`pip list`
3. Excel文件是否可以正常打开
4. 字段名中是否有特殊字符

---

## 📅 更新日志

**2025-10-25**
- ✅ 添加GUI文件选择功能
- ✅ 添加字段唯一性检查和警告
- ✅ 支持不同字段名的ID匹配
- ✅ 修复编号跳号bug
- ✅ 优化用户交互流程

---

**祝数据处理顺利！** 🎉
